name: Deploy Mini Meeting Backend to VPS

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/deploy.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e  # Exit if any command fails

            echo "ğŸ“¦ Starting deployment..."
            cd /mini-meeting

            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main

            echo "ğŸ³ Navigating to backend directory..."
            cd backend

            echo "ğŸ”¨ Rebuilding and restarting Docker containers..."
            docker compose down
            docker compose up -d --build

            echo "â³ Waiting for containers to be ready..."
            sleep 10

            echo "âœ… Checking container status..."
            docker compose ps

            echo "ğŸ“Š Container logs (last 20 lines)..."
            docker compose logs --tail=20

            echo "ğŸ‰ Deployment to VPS successful!"
